#!/usr/bin/env zsh

# whatcodec - æ£€æŸ¥è§†é¢‘ç¼–ç æ ¼å¼çš„ç‹¬ç«‹å·¥å…·
# æ”¯æŒæœ¬åœ°æ–‡ä»¶ã€URL å’Œç›´æ¥åˆ†ææ¨¡å¼
# å‚æ•°ï¼š--direct ç›´æ¥åˆ†æ URLï¼Œ--keep ä¿ç•™ä¸´æ—¶æ–‡ä»¶
# æ”¯æŒçš„è¾“å…¥ï¼šæœ¬åœ°æ–‡ä»¶è·¯å¾„ã€URLã€FLV æ–‡ä»¶
# è¿”å›ï¼šè§†é¢‘ç¼–ç æ ¼å¼æˆ–é”™è¯¯ä¿¡æ¯

whatcodec() {
  local input=""
  local direct_mode=false
  local keep_mode=false

  for arg in "$@"; do
    case "$arg" in
      --direct) direct_mode=true ;;
      --keep) keep_mode=true ;;
      http*) input="$arg" ;;
      /*|./*|*.flv|*.mp4|*.m3u8) input="$arg" ;;
      *) echo "â— æœªè¯†åˆ«çš„å‚æ•°ï¼š$arg" ;;
    esac
  done

  if [[ -z "$input" ]]; then
    echo "âŒ ç¼ºå°‘è¾“å…¥è·¯å¾„æˆ–URL"
    return 1
  fi

  if [[ -f "$input" && "$direct_mode" = false ]]; then
    echo "ğŸ“ åˆ†ææœ¬åœ°æ–‡ä»¶ï¼š$input"
    local codec_name
    codec_name=$(ffprobe -v error -select_streams v:0 \
      -show_entries stream=codec_name \
      -of default=nokey=1:noprint_wrappers=1 "$input")

    if [[ -n "$codec_name" && "$codec_name" != "unknown" ]]; then
      local readable=""
      case "$codec_name" in
        h264) readable="AVC (H.264)" ;;
        hevc) readable="HEVC (H.265)" ;;
        mpeg4) readable="MPEG-4 Part 2" ;;
        vp9) readable="Google VP9" ;;
        av1) readable="AV1" ;;
        *) readable="Unknown Format" ;;
      esac
      echo "ğŸï¸ ç¼–ç ç±»å‹ï¼š$readableï¼ˆcodec_name=$codec_nameï¼‰"
    else
      # codec_name=unknownï¼Œå°è¯•è¯»å– FLV codec_id
      local ext="${input##*.}"
      if [[ "$ext" == "flv" ]]; then
        local tag=$(ffprobe -v error -show_entries stream=codec_tag \
          -of default=noprint_wrappers=1:nokey=1 "$input" | head -n 1)
        tag=${tag#0x}
        tag=${tag:l}
        local id=$((16#$tag))
        case $id in
          2) echo "ğŸï¸ ç¼–ç ç±»å‹ï¼šSorenson H.263ï¼ˆcodec_id=$idï¼‰" ;;
          3) echo "ğŸï¸ ç¼–ç ç±»å‹ï¼šScreen videoï¼ˆcodec_id=$idï¼‰" ;;
          4) echo "ğŸï¸ ç¼–ç ç±»å‹ï¼šOn2 VP6ï¼ˆcodec_id=$idï¼‰" ;;
          5) echo "ğŸï¸ ç¼–ç ç±»å‹ï¼šOn2 VP6 with alphaï¼ˆcodec_id=$idï¼‰" ;;
          6) echo "ğŸï¸ ç¼–ç ç±»å‹ï¼šScreen video v2ï¼ˆcodec_id=$idï¼‰" ;;
          7) echo "ğŸï¸ ç¼–ç ç±»å‹ï¼šAVC (H.264)ï¼ˆcodec_id=$idï¼‰" ;;
          12) echo "ğŸï¸ ç¼–ç ç±»å‹ï¼šHEVC (H.265)ï¼ˆcodec_id=$idï¼‰" ;;
          *) echo "ğŸï¸ ç¼–ç ç±»å‹æœªçŸ¥ï¼ˆcodec_id=$idï¼‰" ;;
        esac
      else
        echo "â“ æ— æ³•è¯†åˆ«ç¼–ç ç±»å‹ï¼ˆcodec_name=unknownï¼‰"
      fi
    fi
    return
  fi

  if $direct_mode; then
    echo "ğŸ“¡ ç›´æ¥åˆ†æ URLï¼š$input"
    ffprobe -v error -select_streams v:0 \
      -show_entries stream=codec_name \
      -of default=nokey=1:noprint_wrappers=1 "$input"
    return
  fi

  local ts=$(date +%Y%m%d%H%M%S)
  local tmpfile="./temp_whatcodec_$ts.flv"
  echo "â¬‡ï¸ ä¸‹è½½è§†é¢‘ï¼š$input"
  curl --silent --max-time 15 --location --output "$tmpfile" "$input"

  if [[ ! -s "$tmpfile" ]]; then
    echo "âŒ ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
    $keep_mode || rm -f "$tmpfile"
    return 1
  fi

  whatcodec "$tmpfile"
  $keep_mode || rm -f "$tmpfile"
}

# å¦‚æœç›´æ¥æ‰§è¡Œè„šæœ¬ï¼Œåˆ™è°ƒç”¨å‡½æ•°
if [[ "${BASH_SOURCE[0]}" == "${0}" ]] || [[ "${(%):-%x}" == "$0" ]]; then
  whatcodec "$@"
fi